## 概要
このシステムは、Pythonを使用したリアルタイム居眠り検知システムです。Webカメラを使用して顔のランドマークを検出し、目の開閉状態を監視します。一定時間以上目が閉じていると、アラームが鳴り、CSVログが記録されます。プログラム終了時には、自動的にSlackにログファイルが送信されます。

## 主な機能
- リアルタイムでの目の開閉検出
- 閾値を超えた場合のアラーム発動
- CSVログへの詳細な記録
- プログラム終了時のSlack自動送信
- オフライン時の再送信機能

## 環境構築

### 1. Pythonのインストール
Python 3.8以上をインストールしてください。
[Python公式サイト](https://www.python.org/downloads/)

### 2. 必要ライブラリのインストール
```bash
pip install -r requirements.txt
```

### 3. Slack設定
1. `.env.template`を`.env`にリネーム
2. SlackのAPIトークンとチャンネルIDを設定
```
SLACK_TOKEN=xoxb-your-token-here
SLACK_CHANNEL=C12345ABCDE
```

## 使用方法

### 実行ファイルから実行（推奨）
1. `drowsiness_watcher.exe`をダブルクリック
2. 終了するには、ウィンドウの'q'キーを押すか、ウィンドウを閉じる

### Pythonから実行（開発者向け）
```bash
python main.py
```

## CSVログ形式
生成されるCSVログは以下の形式です：

| カラム名 | 型 | 例 | 説明 |
|---------|------|---------|---------|
| timestamp | str | 2025-05-05 14:01:02 | ログ記録の日時（秒単位） |
| ear_value | float | 0.221 | 両目の平均EAR |
| status | str | Open / Blinking / Closed | 状態判定 |
| closed_duration | float | 1.3 | 閉じ続けた秒数（閾値超えで警報対象） |
| alert_triggered | bool | True / False | アラートが実行されたか |
| device_name | str | DESKTOP-9F3U1Q0 | ホストPC名（自動取得） |
| user_name | str | yamada | ログインユーザー名（自動取得） |
| mode | str | "auto" | "auto"固定（研修／業務識別なし） |

## 運用シナリオ

| 運用場所 | 実行環境 | 実行方法 | ログ保存 | Slack送信 |
|---------|----------|----------|----------|-----------|
| 広告監視センター | 固定端末（夜勤オペレータ） | exeを直接クリック | デスクトップ | 停止時に自動送信 |
| リモートワークPC | 社員PC（個人用） | スタートアップ起動 or タスク登録 | デスクトップ | 停止時に自動送信 |
| 社員合同研修 | 各人貸与ノートPC | 講師指示でexeを起動 | デスクトップ | 終了で送信 |

## 技術詳細

### 目の開閉検出
- MediapipeのFaceMeshを使用して顔のランドマークを検出
- EAR（Eye Aspect Ratio）を計算して目の開閉状態を判定
- 閾値（デフォルト0.25）以下で目が閉じていると判定

### CSVログ
- 1秒ごとに状態を記録
- バックアップフォルダにも同時保存（データ消失防止）

### Slack送信
- プログラム終了時に自動送信
- 送信失敗時はログを残し、次回起動時に再送信

## EXE化手順（開発者向け）
```bash
# PyInstallerのインストール
pip install pyinstaller

# EXEファイルの生成
pyinstaller drowsiness_watcher.spec
```

## トラブルシューティング

### カメラが認識されない
- カメラドライバーを更新
- 他のアプリでカメラが使用されていないか確認

### Slack送信エラー
- `.env`ファイルの設定を確認
- トークンの権限が適切か確認（files:write権限が必要）
- インターネット接続を確認

## 注意事項
- 本システムは注意喚起のためのものであり、医療機器ではありません
- 長時間の使用は目の疲れの原因になる可能性があります
- カメラの前に顔がはっきり映るようにしてください
